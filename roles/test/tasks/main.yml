---
- name: Check restore rclone.conf exists
  local_action: stat path="{{playbook_dir}}/rclone.conf"
  register: restore_rclone_conf

- name: Restore rclone.conf as part of restore process
  copy:
    src: "{{playbook_dir}}/rclone.conf"
    dest: "{{dirs.data}}/rclone/rclone.conf"
    mode: 0775
    owner: "{{user}}"
    group: "{{user}}"
  register: rclone_conf_copy
  when: restore_rclone_conf.stat.exists

- name: Debug
  msg: "{{ rclone_conf_copy.changed }}"
- name: Symlink rclone.conf to user folder
  file:
    src: "{{dirs.data}}/rclone/rclone.conf"
    dest: "/home/{{user}}/.config/rclone/rclone.conf"
    owner: "{{user}}"
    group: "{{user}}"
    state: link
    force: true
  when: restore_rclone_conf.stat.exists

- name: Check service exists
  stat:
    path: "/etc/systemd/system/rclone.service"
  register: rclone_service

- name: Stop existing rclone service
  systemd: state=stopped name=rclone
  when: rclone_service.stat.exists

- name: Copy rclone.service systemd file
  template:
    src: rclone.service.js2
    dest: /etc/systemd/system/rclone.service
    owner: root
    group: root
    mode: 0644

- name: Systemd daemon-reload
  systemd: state=stopped name=rclone daemon_reload=yes enabled=no

- name: Check config exists
  stat:
    path: "{{dirs.data}}/rclone/rclone.conf"
  register: rclone_config

- name: Start rclone service
  systemd: state=started name=rclone enabled=yes
  when: rclone_config.stat.exists

#- name: Remove restored rclone.conf
#  file:
#    path: "{{playbook_dir}}/rclone.conf"
#    state: absent
#  when: restore_rclone_conf.stat.exists
